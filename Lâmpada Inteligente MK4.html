<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de L√¢mpada por Gestos - Mobile Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f5f5f5;
            margin: 0;
            min-height: 100vh;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.5rem;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 500px;
        }
        
        .instructions {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            font-size: 0.9rem;
        }
        
        .permission-help {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            font-size: 0.8rem;
            display: none;
        }
        
        .lamp-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }
        
        .lamp-container {
            position: relative;
            width: 120px;
            height: 160px;
        }
        
        .lamp-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 25px;
            background-color: #8B4513;
            border-radius: 5px 5px 0 0;
        }
        
        .lamp-stand {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 80px;
            background-color: #696969;
        }
        
        .lamp-bulb {
            position: absolute;
            bottom: 105px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            background-color: #f0f0f0;
            border-radius: 50%;
            transition: all 0.5s ease;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        
        .lamp-bulb.on {
            background-color: #FFD700;
            box-shadow: 0 0 30px #FFD700, 0 0 60px rgba(255, 215, 0, 0.5);
        }
        
        .lamp-bulb.off {
            background-color: #f0f0f0;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        
        .status-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            margin-top: 5px;
        }
        
        .status {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            transition: color 0.3s;
            min-height: 20px;
        }
        
        .confidence {
            font-size: 13px;
            color: #666;
            text-align: center;
            min-height: 16px;
        }
        
        .control-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }
        
        button {
            padding: 12px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 200px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .webcam-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        #webcam-container {
            border: 2px solid #333;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            width: 200px;
            height: 200px;
            background-color: #000;
        }
        
        .webcam-overlay {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            z-index: 10;
        }
        
        #label-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
            max-width: 250px;
        }
        
        #label-container div {
            padding: 6px 10px;
            background-color: #e9e9e9;
            border-radius: 5px;
            text-align: center;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        
        #label-container div.high-confidence {
            background-color: #4CAF50;
            color: white;
        }
        
        .detection-info {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
            text-align: center;
            display: none;
            width: 100%;
        }
        
        .mobile-tips {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #bee5eb;
            font-size: 0.8rem;
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>Controle de L√¢mpada por Gestos</h1>
    
    <div class="container">
        <div class="instructions">
            <strong>Instru√ß√µes:</strong> Mostre a m√£o <strong>aberta</strong> para ligar e <strong>fechada</strong> para desligar a l√¢mpada
        </div>
        
        <div class="mobile-tips">
            üì± <strong>Dica Mobile:</strong> Toque em "Iniciar Detec√ß√£o" e <strong>PERMITA</strong> o acesso √† c√¢mera quando solicitado
        </div>
        
        <div class="permission-help" id="permissionHelp">
            üîß Se n√£o aparecer a permiss√£o:<br>
            1. Toque em ‚ãÆ (menu) ‚Üí Configura√ß√µes<br>
            2. Site settings ‚Üí C√¢mera<br>
            3. Permita o acesso √† c√¢mera
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="lamp-section">
            <div class="lamp-container">
                <div class="lamp-bulb off" id="lamp"></div>
                <div class="lamp-stand"></div>
                <div class="lamp-base"></div>
            </div>
            <div class="status-container">
                <div class="status" id="status">L√¢mpada: DESLIGADA</div>
                <div class="confidence" id="confidence">Confian√ßa: 0%</div>
            </div>
        </div>
        
        <div class="control-section">
            <button type="button" onclick="init()" id="startButton">Iniciar Detec√ß√£o</button>
            
            <div class="webcam-section">
                <div id="webcam-container">
                    <div class="webcam-overlay">Webcam</div>
                </div>
                <div id="label-container"></div>
                <div class="detection-info">Mantenha o gesto por 1-2 segundos para melhor detec√ß√£o</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    
    <script type="text/javascript">
        // URL do modelo fornecido pelo Teachable Machine
        const URL = "https://teachablemachine.withgoogle.com/models/o6qJKRcZK/";

        let model, webcam, labelContainer, maxPredictions;
        let currentLampState = "off";
        let confidenceHistory = [];
        let lastStableGesture = null;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // Mostrar ajuda de permiss√£o para mobile
        if (isMobile) {
            document.getElementById('permissionHelp').style.display = 'block';
        }

        // Carregar o modelo de imagem e configurar a webcam
        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            const startButton = document.getElementById('startButton');
            const errorMessage = document.getElementById('errorMessage');
            
            try {
                startButton.disabled = true;
                startButton.textContent = 'Carregando...';
                errorMessage.style.display = 'none';

                // Carregar o modelo e metadados
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                // Configurar webcam com par√¢metros otimizados para mobile
                const flip = true;
                webcam = new tmImage.Webcam(200, 200, flip);
                
                // Configura√ß√µes espec√≠ficas para mobile
                if (isMobile) {
                    webcam.webcamConfig = {
                        facingMode: 'user', // Usar c√¢mera frontal
                        width: 200,
                        height: 200
                    };
                }
                
                await webcam.setup();
                await webcam.play();
                window.requestAnimationFrame(loop);

                // Adicionar elementos ao DOM
                const webcamContainer = document.getElementById("webcam-container");
                // Limpar conte√∫do anterior se existir
                while (webcamContainer.children.length > 1) {
                    webcamContainer.removeChild(webcamContainer.lastChild);
                }
                webcamContainer.appendChild(webcam.canvas);
                
                // Configurar container de labels
                labelContainer = document.getElementById("label-container");
                labelContainer.innerHTML = ''; // Limpar labels anteriores
                for (let i = 0; i < maxPredictions; i++) {
                    labelContainer.appendChild(document.createElement("div"));
                }
                
                startButton.textContent = 'Detec√ß√£o Ativa';
                startButton.style.backgroundColor = '#2196F3';
                
            } catch (error) {
                console.error("Erro ao inicializar:", error);
                
                let errorText = "Erro ao acessar a webcam. Verifique as permiss√µes.";
                
                if (error.name === 'NotAllowedError') {
                    errorText = "‚ùå Permiss√£o da c√¢mera negada. Por favor, permita o acesso √† c√¢mera nas configura√ß√µes do seu navegador.";
                } else if (error.name === 'NotFoundError') {
                    errorText = "üì∑ C√¢mera n√£o encontrada. Verifique se seu dispositivo possui c√¢mera.";
                } else if (error.name === 'NotSupportedError') {
                    errorText = "üåê Seu navegador n√£o suporta acesso √† c√¢mera. Tente usar Chrome ou Firefox.";
                } else if (error.name === 'NotReadableError') {
                    errorText = "‚ö†Ô∏è C√¢mera j√° est√° em uso por outro aplicativo.";
                }
                
                errorMessage.textContent = errorText;
                errorMessage.style.display = 'block';
                
                startButton.disabled = false;
                startButton.textContent = 'Tentar Novamente';
                startButton.style.backgroundColor = '#4CAF50';
                
                // Mostrar instru√ß√µes espec√≠ficas para mobile
                if (isMobile) {
                    document.getElementById('permissionHelp').style.display = 'block';
                }
            }
        }

        async function loop() {
            if (webcam) {
                webcam.update();
                await predict();
                window.requestAnimationFrame(loop);
            }
        }

        // Executar a imagem da webcam atrav√©s do modelo
        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            
            let highestProb = 0;
            let highestClass = "";
            
            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction = prediction[i].className + ": " + (prediction[i].probability * 100).toFixed(1) + "%";
                if (labelContainer.childNodes[i]) {
                    labelContainer.childNodes[i].innerHTML = classPrediction;
                    
                    // Destacar detec√ß√µes com alta confian√ßa
                    if (prediction[i].probability > 0.8) {
                        labelContainer.childNodes[i].classList.add('high-confidence');
                    } else {
                        labelContainer.childNodes[i].classList.remove('high-confidence');
                    }
                }
                
                if (prediction[i].probability > highestProb) {
                    highestProb = prediction[i].probability;
                    highestClass = prediction[i].className;
                }
            }
            
            // Atualizar indicador de confian√ßa
            document.getElementById('confidence').textContent = `Confian√ßa: ${(highestProb * 100).toFixed(1)}%`;
            
            // Controlar a l√¢mpada com sistema de estabilidade
            controlLamp(highestClass, highestProb);
        }

        // Sistema melhorado de controle da l√¢mpada
        function controlLamp(gesture, probability) {
            const lamp = document.getElementById("lamp");
            const status = document.getElementById("status");
            
            // Adicionar ao hist√≥rico
            confidenceHistory.push({gesture, probability, timestamp: Date.now()});
            
            // Manter apenas os √∫ltimos 2 segundos de hist√≥rico
            const twoSecondsAgo = Date.now() - 2000;
            confidenceHistory = confidenceHistory.filter(item => item.timestamp > twoSecondsAgo);
            
            // Encontrar o gesto mais consistente no hist√≥rico recente
            const consistentGesture = getConsistentGesture();
            
            // Aplicar mudan√ßas apenas se houver gesto consistente e alta confian√ßa
            if (consistentGesture && probability > 0.75) {
                if (consistentGesture === "Open" && currentLampState !== "on") {
                    lamp.classList.remove("off");
                    lamp.classList.add("on");
                    status.textContent = "L√¢mpada: LIGADA ‚úì";
                    status.style.color = "#2E8B57";
                    currentLampState = "on";
                    lastStableGesture = "Open";
                } else if (consistentGesture === "Closed" && currentLampState !== "off") {
                    lamp.classList.remove("on");
                    lamp.classList.add("off");
                    status.textContent = "L√¢mpada: DESLIGADA ‚úó";
                    status.style.color = "#DC143C";
                    currentLampState = "off";
                    lastStableGesture = "Closed";
                }
            } else if (probability < 0.6) {
                // Feedback quando a detec√ß√£o √© incerta
                status.textContent = "Fa√ßa um gesto claro (m√£o aberta/fechada)";
                status.style.color = "#FF8C00";
            }
        }

        // Encontrar o gesto mais consistente no hist√≥rico
        function getConsistentGesture() {
            if (confidenceHistory.length < 3) return null;
            
            // Contar ocorr√™ncias de cada gesto com alta confian√ßa
            const counts = {};
            confidenceHistory.forEach(item => {
                if (item.probability > 0.7) {
                    counts[item.gesture] = (counts[item.gesture] || 0) + 1;
                }
            });
            
            // Encontrar o gesto com mais ocorr√™ncias
            let maxCount = 0;
            let consistentGesture = null;
            
            for (let gesture in counts) {
                if (counts[gesture] > maxCount) {
                    maxCount = counts[gesture];
                    consistentGesture = gesture;
                }
            }
            
            // Retornar apenas se houver pelo menos 3 detec√ß√µes consistentes
            return maxCount >= 3 ? consistentGesture : null;
        }

        // Tentar detectar automaticamente se √© mobile e mostrar instru√ß√µes
        if (isMobile) {
            document.addEventListener('click', function() {
                // Em mobile, o usu√°rio precisa interagir primeiro para pedir permiss√£o
            }, { once: true });
        }
    </script>
</body>
</html>